name: FastAPI Deploy via Bastion

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key for Bastion
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.BASTION_KEY }}" > ~/.ssh/deploy.key
          chmod 600 ~/.ssh/deploy.key
          ssh-keyscan -T 5 -H ${{ secrets.BASTION_HOST }} >> ~/.ssh/known_hosts || true

      - name: Upload app folder to Bastion
        run: |
          ssh -i ~/.ssh/deploy.key ${{ secrets.BASTION_USER }}@${{ secrets.BASTION_HOST }} \
            "mkdir -p ~/FastAPI_TMP/app && rm -rf ~/FastAPI_TMP/app/*"

          rsync -avz -e "ssh -i ~/.ssh/deploy.key" \
            ./app/ \
            ${{ secrets.BASTION_USER }}@${{ secrets.BASTION_HOST }}:~/FastAPI_TMP/app/

      - name: Deploy to FastAPI server via Bastion
        run: |
          ssh -i ~/.ssh/deploy.key ${{ secrets.BASTION_USER }}@${{ secrets.BASTION_HOST }} bash -s << 'EOF'
            # Bastion에서 FastAPI 서버 접속 가능
            rsync -avz --delete /home/ubuntu/FastAPI_TMP/app/ fastapi2a:/home/ubuntu/fastapiBack1/app

            ssh fastapi2a bash -s << 'INNER'
              cd /home/ubuntu/fastapiBack1
              source .venv/bin/activate
              ./start.sh
INNER
EOF
